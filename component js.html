

<!-- saved from url=(0062)http://www.uco.es/~in1rosaj/tools/jsUML2/ejemplos/classGS.html -->
<!-- blueprint unreal -> http://www.michalorzelek.com/blog/wp-content/uploads/2014/07/ForestGenerator_CreateGrid.png -->
<html>
	<body bgcolor="#444444">	
		<!-- https://www.base64-image.de/ -->
		<!-- http://icon-icons.com/descargaimagen.php?id=50262&root=510/PNG/32/&file=ios7-gear_icon-icons.com_50262.png -->
		<img id="img_engrenagem" width="20" style="display: none" height="20" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAalJREFUWIXt1r9OVEEUBvAfmmB8AAwJsVADUqkkJFKpJBbSUJBoZyiIGlsihRoBY+K/t9CCN7CxkTcggUCBBBcSCmy0MyYKFndXxrv33szOLlb7JaeZOed8351zZu6hiy7ScAZrOKxbDRf/p4B7AXnDXqQkOhHhcxOvMBSsnS7wC9f664Jup4gKcRe/ZF/4FdcxiBXNJ1DDpbpt1dcO8DiVfCIgb8cOMFNGUlWCGziZqj5Aj6yMLeMc9rR/At8xmqr+aknSDxiXNd4pjGFJdtx536lUcrKGyydcrPB/UCBivFXSs5jFE6znkn2MiH+Xi9nBMzzChRgBm8rrORERf6UifjNGQFVD9UXE9+BnSfyPvHPMS3isKBLwucI/5jpdRm/J3m5E/N8mfKozTVjDPOZENmGIIc11XKjwv6/5Gl5rlTREJx6iyVTy8zrzFH/DSIqANx0gb9j7MpKqa7iM3ynKczjEp9TgaUczwb6soYaxqvkrv8hewVFsO5oFkgeSBm7htezH1MBsgYC3wf4AXuJOu+RleFgg4PlxkRWhHxsB+Y5/h9YuuojGH6lk4lTsctw/AAAAAElFTkSuQmCC">		
				
		
		<!--<div id="diagrama"  style="position: relative;" ></div> -->
		<div style="position: relative;">
			<div id="diagrama1" style="z-index: 0;"></div>
			
			<div id="diagrama2" style="z-index: 1;"></div>
		</div>

		
	</body>	
</html>



<script type="text/javascript">

var context = null;
var ctx2 = null;
var tela_=null;
//copy(can.toDataURL("image/png")+"");
	
	
var Tela = function(a) {
	// validacao
    if (document.getElementById('diagrama1') == null || document.getElementById('diagrama1').nodeName != "DIV") { alert("ERROR"); console.log("DIV \"" + document.getElementById('diagrama1') + "\" nao encontrada!"); return;}
	tela_=this;
	
    this._width = a.width;
    this._height = a.height;
	this._name = a.name;
	
	this._fundos = [];
	this._nodes = [];
	this._ligacoes = []; // [[origem,numseq,destino,numseq]]
	
	this._flying = null; // 	[id,numseq,isSender,x,y]
	this._p2_correcao_flying = null;
	
	// canvas context
	var can = document.createElement("canvas");
    can.width = this._width;
    can.height = this._height;
    context = can.getContext("2d");
	document.getElementById('diagrama1').appendChild(can);
	context.globalAlpha = .4;	
	
    this._element = null;
	this._mouseSobreSlot = null;
	
	this.show = function() {			
		this._p2_correcao_flying = null;
		context.clearRect(0, 0, this._width, this._height);   // clean
		context.fillStyle = "#222222";                        // branco		
		context.fillRect(0, 0, this._width, this._height);	  // preenchendo fundo				
		
		for (var i = 0; i < this._fundos.length; i++)   this._fundos[i].show()		
		for (var i = 0; i < this._nodes.length; i++)   	this._nodes[i].show()		
		for (var i = 0; i < this._ligacoes.length; i++) this.showligacao(this._ligacoes[i]);		
		
		if ( this._flying != null ){						
			var p1=this._nodes[this._flying[0]].getPoint(this._flying[1],!this._flying[2]);
			var p2=[this._flying[3]-8+20,this._flying[4]-8];
			if ( this._p2_correcao_flying != null )				
				p2=this._p2_correcao_flying;
			this.showfio(p1,p2);			
		}
		
	};

	// rotinas externas
    this.mousedown = function(e) { tela_.mousedown_redefined(e); };
    this.mousemove = function(e) { tela_.mousemove_redefined(e); };
    this.mouseup =   function(e) { tela_.mouseup_redefined(e);   };	

    this.mousedown_redefined = function(e) {
		var tmp=10;
        for (var b = 0; b < this._nodes.length ; b++) {						
			// clickando no node
			if ( this._nodes[b].inside(e.pageX-8,e.pageY-8) ){
				var slot = this._nodes[b].insideSlot(e.pageX-8,e.pageY-8);
				// clickando em um slot ligado
				if ( slot != null && this._nodes[b].getnumligacaobyslot(slot[0],slot[1],0) != -1 && !slot[1]){
					var n_ligacao = this._nodes[b].getnumligacaobyslot(slot[0],slot[1],0);
					var id=-1;
					if ( !slot[1] )
						id=this._ligacoes[n_ligacao][0];
					else
						id=this._ligacoes[n_ligacao][2];
						
					// mesmo que a consistencia de -1 ja foi feita, aqui precisamos consistir novamente por questoes de segurança, caso seja feito alguma alteração acima
					if ( n_ligacao != -1 )
					{
						this._ligacoes.splice(n_ligacao,1);						
						this._flying = [id,slot[0],slot[1],e.pageX,e.pageY];
						this.show();
					}								
				}else{			
					// gerando nova linha
					if ( slot != null && slot[1] )
					{
						this._flying = [b,slot[0],!slot[1],e.pageX-8,e.pageY-8];
					}else{
						this._nodes[b]._relx = e.pageX - this._nodes[b]._x;
						this._nodes[b]._rely = e.pageY - this._nodes[b]._y;
						this._element = this._nodes[b];
						break;
					}
				}
            }
        };
    };
	
	this.mousemove_redefined = function(e) {		
		var tmp=10;
		
		if ( this._mouseSobreSlot != null){
			this._mouseSobreSlot=null;
		}

		
		// moving
		if(this._element != null ){
			// limite de borda
			if (e.pageX < 0 || e.pageY < 0 || e.pageX >= this._width || e.pageY >= this._height) return;
			// movendo coordenadas do objeto
			this._element._x = e.pageX - this._element._relx;
			this._element._y = e.pageY - this._element._rely;			
		}else{
			// flying
			if ( this._flying != null ){						
				this._flying = [this._flying[0],this._flying[1],this._flying[2],e.pageX,e.pageY];
			}
			// analise contornos
			for (var b = 0; b < this._nodes.length ; b++) {			
				if ( this._nodes[b].inside(e.pageX-8,e.pageY-8) ){
					var slot = this._nodes[b].insideSlot(e.pageX-8,e.pageY-8);						
					if ( slot != null ){						
						this._mouseSobreSlot=[b,slot[0],slot[1]];												
						break;
					}
				}
			};							
		}
		
		// printando o objeto se movendo		
        this.show()		
	}
	
	this.mouseup_redefined = function(e){
		if ( this._flying != null )
			this._flying = null;
		this._element = null;
		this.show();
	}

	this.showfio = function(p1,p2){
		var tmp=95;
		var tmp2=0;
		var tmp3=0;
		
		tmp2=p1[0]-p2[0];		
		if ( tmp2 < 0 )
			tmp3+=tmp2*-1;
		else
			tmp3+=tmp2;
			
		tmp2=p1[1]-p2[1];		
		if ( tmp2 < 0 )
			tmp3+=tmp2*-1;
		else
			tmp3+=tmp2;
		tmp3/=2;
		if ( tmp3 < tmp )
			tmp=tmp3;		
		

		// deslocando a posição de slot para ponta do fio		
		p1[0]+=5.5;
		p2[0]-=20;			
		
		context.lineWidth = 3;
		context.strokeStyle = "#509090";	
		context.beginPath();
		context.moveTo(p1[0], p1[1]);
		context.quadraticCurveTo(p1[0]+tmp, p1[1], (p1[0]+p2[0])/2, (p1[1]+p2[1])/2 );
		context.moveTo(p2[0], p2[1]);
		context.quadraticCurveTo(p2[0]-tmp, p2[1], (p1[0]+p2[0])/2, (p1[1]+p2[1])/2 );
		
		context.stroke();	
	}
	
	this.showligacao = function(info){
		
		// info contem,    num node, pos, num node, pos
		if ( info[0] <= this._nodes.length && info[2] <= this._nodes.length && info[1] < this._nodes[info[0]]._n_slots_dir && info[3] < this._nodes[info[2]]._n_slots_esq )
		{
			var p1 = this._nodes[info[0]].getPoint(info[1],true);
			var p2 = this._nodes[info[2]].getPoint(info[3],false);
			
			this.showfio(p1,p2);
		}
	}
	
	this.existeEssaLigacao = function(n1,n2,n3,n4){		
		for ( var i=0;i<this._ligacoes.length;i++ )
			if ( this._ligacoes[i][0] == n1 && this._ligacoes[i][1] == n2 && this._ligacoes[i][2] == n3 && this._ligacoes[i][3] == n4)
				return true;				
		return false;
	}
	
	this.addNode = function(a,b,c){
		this._nodes.push(new Node({ x:a, y:b, name:c }));
	}

	this.addLigacao = function(a,b,c,d){
		this._ligacoes.push([a,b,c,d]);
	}

	window.addEventListener("mousedown", this.mousedown, false);
	window.addEventListener("mousemove", this.mousemove, false);
	window.addEventListener("mouseup", this.mouseup, false);	

	this._fundos.push(new Fundo());
};


var Fundo = function() {
	this.show = function() {
		for ( var i=10;i<2000;i+=120){
			this.linha(i,2000,0);
			this.linha(i,2000,1);
			this.cubo(i,2000)
		}	
	}

	this.linha = function(a,b,c) {
		var d=2;

		context.beginPath();
		context.fillStyle = "#070707";	
		if ( c == 0 ){
			for ( var i=13-120;i<b;i+=120 )
			{
				context.moveTo(a, i);
				context.lineTo(a+d,i);
				context.lineTo(a+d,i+117);
				context.lineTo(a,i+117);
				context.lineTo(a,i);
			}
		}else{
			context.moveTo(0, a);
			context.lineTo(0,a+d);
			context.lineTo(b,a+d);
			context.lineTo(b,a);
			context.lineTo(0,a);
		}
		
		context.fill();	
	}

	this.cubo = function(a,b) {
		a+=3-120;
		tmp=14;
		context.beginPath();
		context.fillStyle = "#222222";	
		for ( var i=13-120;i<b;i+=120 )
		{
			for ( var j=0;j<8;j++ )
			{
				for ( var k=0;k<8;k++ )
				{
					context.moveTo(a+j*15, i+k*15);
					context.lineTo(a+tmp+j*15,i+k*15);
					context.lineTo(a+tmp+j*15,i+tmp+k*15);
					context.lineTo(a+j*15,i+tmp+k*15);
					context.lineTo(a+j*15,i+k*15);
				}
			}
		}
		
		context.fill();	
		
	}
};


var Node = function(a) {	
	this._linha = 10;	
	this._fresta = 10;
	
    this._x = a.x;
    this._y = a.y;
	
	this._height = 70;
	this._width = 150;
	
	this._text = a.name;
	
	this._relx = 0;
	this._rely = 0;
		
	this._espaco_entre_slots = 25;
	this._n_slots_esq=2;
	this._n_slots_dir=2;
	
	this._cor_fio="#599";
	this._cor_slot="#599";
	
	this._cor1="#2E9AFE";	// cor degrade 1     - azul
	this._cor2="#444444";	// cor degrade 2     - cinza
	this._cor3="#030303";	// cor preenchimento - preto
	
	this._fonte_txt = ' 12pt Calibri';
	this._px_fonte_txt = 16;
	this._cor_fonte_txt = '#ffffff';
	
	this._lineWidth = 3;

	this.linha = function(x1,y1,x2,y2){
		context.lineWidth = this._lineWidth;
		context.strokeStyle = this._cor_fio;	
		context.beginPath();
		context.moveTo(100, 250);
		context.quadraticCurveTo(300.43242, 250, 400, 500);
		context.stroke();

	}

	this.printa = function(x1,y1,x2,y2,cor1,degrade,x,y,cor2,cor3) {
		context.beginPath();
		
		if ( degrade ){
			var gradient=context.createRadialGradient(x-60,y-100,5,x-60,y-100,200);
			gradient.addColorStop("0.6",cor2);
			gradient.addColorStop("1.0",cor3);	
			context.fillStyle = gradient;
			context.fillRect(x1,y1,x2-x1,y2-y1);
		}else{
			context.moveTo(x1, y1);
			context.lineTo(x2, y1);
			context.lineTo(x2, y2);
			context.lineTo(x1, y2);
			context.fillStyle = cor1;	
		}
		
		context.fill();	
	}

	this.printaborda = function(x,y,linha,tipo_borda,cor) {
		context.beginPath();			
		context.strokeStyle = cor;		
		context.lineWidth = linha;	
		context.arc(x, y, linha/2, Math.PI*(tipo_borda/2+0.5), Math.PI*(tipo_borda/2+1));
		context.stroke();
	}

	this.printatexto = function(x,y,txt,cor,fonte,altura_fonte_em_px) {
		context.drawImage(document.getElementById("img_engrenagem"), x- this._linha*0.5,y - (this._linha+this._fresta-altura_fonte_em_px)/2 - altura_fonte_em_px*1.17 ,22,22);    
		context.beginPath();					
		context.fillStyle = cor;
		context.font = fonte;
		context.fillText(txt, x + this._linha*2,y - (this._linha+this._fresta-altura_fonte_em_px) );
		context.fill();		
	}

	this.getPoint = function(n_slot,isSender){		
		if ( isSender )
			return [this._x+this._width-this._linha*2,this._y+this._fresta+this._linha+this._espaco_entre_slots/2+n_slot*this._espaco_entre_slots];
		return [this._x+this._linha*2,this._y+this._fresta+this._linha+this._espaco_entre_slots/2+n_slot*this._espaco_entre_slots];
	}

	this.getnumligacaobyslot = function(numseq,isSender,requestid){
		var id=this.getidnode();
		var tmp_lig = [];
		for ( var j=0;j<tela_._ligacoes.length;j++ )
		{
			if ( ( isSender && tela_._ligacoes[j][1] == numseq ) || ( !isSender && tela_._ligacoes[j][3] == numseq ) ) {
				if ( ( isSender && tela_._ligacoes[j][0] == id ) || ( !isSender && tela_._ligacoes[j][2] == id ) ){
					if ( requestid == 0 )
						return j;
					tmp_lig.push(j);
				}
			}		
		}
		if ( tmp_lig.length == 0 )
			return -1;
		while ( requestid > 0 ){
			tmp_lig.push(tmp_lig[0]);
			tmp_lig.shift();
		}
		return tmp_lig[0];
	}

	this.getidnode = function(){
		for ( var i=0;i<tela_._nodes.length;i++ ){
			if (this == tela_._nodes[i])
				return i;
		}
		return -1;
	}

	this.printaslots = function(){
		var p = null;	
		var flag_existe_ligacoes = false;
		var flag_flying_inicio = false;
		var flag_mouse_SobreSlot = false;
		var flag_isSender = false;
		
		for ( var i=0;i<this._n_slots_esq;i++ )
		{		
			p = this.getPoint(i,flag_isSender);
			flag_existe_ligacoes = this.getnumligacaobyslot(i,flag_isSender,0) != -1;						
			flag_mouse_SobreSlot = tela_._mouseSobreSlot != null && this.getidnode() == tela_._mouseSobreSlot[0] && tela_._mouseSobreSlot[1] == i && tela_._mouseSobreSlot[2] == flag_isSender;
			flag_flying_inicio = tela_._flying != null && tela_._flying[0] == this.getidnode() && tela_._flying[1] == i && tela_._flying[2] == !flag_isSender;
			flag_flying_fim = tela_._flying != null && tela_._flying[0] != this.getidnode() && flag_mouse_SobreSlot;
			flag_ligacao_repetida = flag_flying_fim && tela_.existeEssaLigacao(tela_._flying[0],tela_._flying[1],this.getidnode(),i);
			if ( flag_flying_fim && !flag_ligacao_repetida )
				tela_._p2_correcao_flying = this.getPoint(i,flag_isSender);
			
			if ( ( flag_flying_fim && !flag_isSender ) || flag_existe_ligacoes || flag_flying_inicio || (flag_mouse_SobreSlot && !flag_existe_ligacoes && flag_isSender && !flag_flying_fim ) ){
				context.beginPath();			
				context.strokeStyle = this._cor_slot;		
				context.lineWidth = this._lineWidth*2;	
				context.arc(p[0], p[1], this._lineWidth*0.9, Math.PI*0.5, Math.PI*2.5);
				context.stroke();
				// print contornos slot
				if ( !flag_ligacao_repetida && ( ( flag_flying_fim && !flag_isSender ) || (flag_existe_ligacoes && flag_mouse_SobreSlot && !flag_isSender ) ) )
					this.printaslotmouse(i,flag_isSender);
			}else{
				context.beginPath();			
				context.strokeStyle = this._cor_slot;		
				context.lineWidth = this._lineWidth/2;	
				context.arc(p[0], p[1], this._lineWidth*1.5, Math.PI*0.5, Math.PI*2.5);
				context.stroke();				
			}
		}
		
		flag_isSender = true;
		for ( var i=0;i<this._n_slots_dir;i++ )
		{
			p = this.getPoint(i,flag_isSender);
			flag_existe_ligacoes = this.getnumligacaobyslot(i,flag_isSender,0) != -1;			
			flag_mouse_SobreSlot = tela_._mouseSobreSlot != null && this.getidnode() == tela_._mouseSobreSlot[0] && tela_._mouseSobreSlot[1] == i && tela_._mouseSobreSlot[2] == flag_isSender;
			flag_flying_inicio = tela_._flying != null && tela_._flying[0] == this.getidnode() && tela_._flying[1] == i && tela_._flying[2] == !flag_isSender;			
			flag_flying_fim = tela_._flying != null && tela_._flying[0] != this.getidnode() && flag_mouse_SobreSlot;
			flag_ligacao_repetida = flag_flying_fim && !tela_.existeEssaLigacao(tela_._flying[0],tela_._flying[1],this.getidnode(),i);
			if ( flag_flying_fim && !flag_ligacao_repetida )
				tela_._p2_correcao_flying = this.getPoint(i,flag_isSender);

			if ( ( flag_flying_fim && !flag_isSender ) || flag_existe_ligacoes || flag_flying_inicio || (flag_mouse_SobreSlot && !flag_existe_ligacoes && flag_isSender && !flag_flying_fim ) ){
				context.beginPath();			
				context.strokeStyle = this._cor_slot;		
				context.lineWidth = this._lineWidth*2;	
				context.arc(p[0], p[1], this._lineWidth*0.9, Math.PI*0.5, Math.PI*2.5);
				context.stroke();
				// print contornos slot
				if ( !flag_ligacao_repetida && ( ( flag_flying_fim && !flag_isSender ) || (flag_existe_ligacoes && flag_mouse_SobreSlot && !flag_isSender ) ) )
					this.printaslotmouse(i,flag_isSender);
			}else{
				context.beginPath();			
				context.strokeStyle = this._cor_slot;		
				context.lineWidth = this._lineWidth/2;	
				context.arc(p[0], p[1], this._lineWidth*1.5, Math.PI*0.5, Math.PI*2.5);
				context.stroke();				
			}
		}
	}

	this.printaslotmouse = function(num_seq,isSender){
		var p = this.getPoint(num_seq,isSender);
		context.strokeStyle = '#ffffff';		
		for ( var i=0;i<2;i+=2/8 ){
			context.beginPath();			
			context.lineWidth = this._lineWidth/4;	
			context.arc(p[0], p[1], this._lineWidth*3.5, Math.PI*i, Math.PI*(i+(1/8)));
			context.stroke();	
		}
	}

	this.show = function() {	
		var linha= this._linha;	
		var fresta = this._fresta;	
		
		var x = this._x+linha;	
		var y = this._y+fresta+linha;

		var width = this._width-linha*2;
		var height = this._height-fresta-linha*2;
		
		var fonte_txt = this._fonte_txt;
		var px_fonte_txt = this._px_fonte_txt;
		var cor_fonte_txt = this._cor_fonte_txt;
		
		var cor1=this._cor1; 	// cor degrade 1     - azul
		var cor2=this._cor2;	// cor degrade 2     - cinza
		var cor3=this._cor3;	// cor preenchimento - preto
		
		// mostra x,y
		//this.printa(x,y,x+3.5,y+3.5,'#ffff00',false,x,y,cor2,cor3);	

		// contornos superiores
		this.printaborda(x,y-fresta,linha,1,cor1);	
		this.printaborda(x+width,y-fresta,linha,2,cor2);	
		// linha entre os contornos

		this.printa(x,y-linha-fresta,x+width,y-fresta,cor3,true,x,y,cor1,cor2);	

		// completando a fresta superior
		this.printa(x-linha,y-fresta,x+width+linha, y,cor3,true,x,y,cor1,cor2);
		
		// contornos inferiores
		this.printaborda(x+width, y+height, linha,3,cor3);
		this.printaborda(x, y+height, linha,4,cor3);
		// 3 linhas restantes
		this.printa(x-linha,y,x,y+height,cor3,false,x,y);
		this.printa(x+width,y,x+width+linha,y+height,cor3,false,x,y,cor1,cor2);
		this.printa(x,y+height,x+width,y+height+linha,cor3,false,x,y,cor1,cor2);

		// preenchendo do objeto
		this.printa(x,y,x+width, y+height,cor3,false,x,y,cor1,cor2);
		
		// preenchendo nome objeto
		this.printatexto(x,y,this._text,cor_fonte_txt,fonte_txt,px_fonte_txt);
		
		this.printaslots();
	};	
	
	this.inside = function(x,y){
		return x >= this._x && x <= this._x + this._width && y >= this._y && y <= this._y + this._height;			
	}
	
	this.insideSlot = function(x,y){
		var tmp=10;
		for ( var c=0;c<this._n_slots_esq;c++ ){
			var p = this.getPoint(c,false);
			if ( x >= p[0]-tmp && x <= p[0]+tmp && y >= p[1]-tmp && y <= p[1]+tmp ){							
				return [c,false];
			}
		}
		for ( var c=0;c<this._n_slots_dir;c++ ){
			var p = this.getPoint(c,true);
			if ( x >= p[0]-tmp && x <= p[0]+tmp && y >= p[1]-tmp && y <= p[1]+tmp ){
				return [c,true];
			}						
		}		
		return null;
	}
};

window.onload = function(){
	var tela = new Tela({width: 1420, height: 790, name: "Component JS "});		
	tela.addNode(150, 250, "dsadasdasdasd");
	tela.addNode(650, 350, "AAA");	
	tela.addNode(950, 200, "ffdsf");		
	tela.addNode(950, 600, "fwfds")
	tela.addLigacao(0,0,1,0);
	tela.addLigacao(0,1,1,1);
	tela.addLigacao(1,0,2,0);
	tela.addLigacao(1,0,3,0);
	tela.show();
}

</script>    
